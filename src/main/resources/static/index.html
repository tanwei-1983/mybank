<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .transaction-card {
            transition: transform 0.2s;
        }
        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .amount-positive {
            color: #28a745;
        }
        .amount-negative {
            color: #dc3545;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .form-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Page Title -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center text-primary">
                    <i class="bi bi-bank"></i> Transaction Management System
                </h1>
            </div>
        </div>

        <!-- Create/Edit Transaction Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="form-container">
                    <h4 id="formTitle">
                        <i class="bi bi-plus-circle"></i> Create New Transaction
                    </h4>
                    <form id="transactionForm">
                        <input type="hidden" id="transactionId" name="id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="accountNumber" class="form-label">Account Number *</label>
                                <input type="text" class="form-control" id="accountNumber" name="accountNumber" 
                                       pattern="^[0-9]{16,19}$" required>
                                <div class="form-text">Please enter a 16-19 digit account number</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionType" class="form-label">Transaction Type *</label>
                                <select class="form-select" id="transactionType" name="transactionType" required>
                                    <option value="">Please select transaction type</option>
                                    <option value="DEPOSIT">Deposit</option>
                                    <option value="WITHDRAWAL">Withdrawal</option>
                                    <option value="TRANSFER">Transfer</option>
                                    <option value="PAYMENT">Payment</option>
                                    <option value="REFUND">Refund</option>
                                    <option value="FEE">Fee</option>
                                    <option value="INTEREST">Interest</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="amount" class="form-label">Amount *</label>
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       step="0.01" min="0.01" max="999999999.99" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="currency" class="form-label">Currency</label>
                                <select class="form-select" id="currency" name="currency">
                                    <option value="CNY">Chinese Yuan (CNY)</option>
                                    <option value="USD">US Dollar (USD)</option>
                                    <option value="EUR">Euro (EUR)</option>
                                    <option value="JPY">Japanese Yen (JPY)</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" 
                                       pattern="^[A-Z_]+$" placeholder="e.g., FOOD_AND_DRINK">
                                <div class="form-text">Only uppercase letters and underscores allowed</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" 
                                          rows="2" maxlength="500" placeholder="Enter transaction description (max 500 characters)"></textarea>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">Please select status</option>
                                    <option value="PENDING">Pending</option>
                                    <option value="COMPLETED">Completed</option>
                                    <option value="FAILED">Failed</option>
                                    <option value="CANCELLED">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2" id="submitBtn">
                                    <i class="bi bi-check-circle"></i> Submit
                                </button>
                                <button type="button" class="btn btn-secondary" id="resetBtn" onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise"></i> Reset
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
                                    <i class="bi bi-x-circle"></i> Cancel Edit
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Transaction List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> Transaction List
                        </h5>
                        <button class="btn btn-success btn-sm" onclick="refreshTransactions()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Account Number</th>
                                        <th>Transaction Type</th>
                                        <th>Amount</th>
                                        <th>Currency</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted">
                                            <i class="bi bi-hourglass-split"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="pagination-container">
                            <button class="btn btn-outline-primary btn-sm" onclick="changePage(-1)" id="prevBtn">
                                <i class="bi bi-chevron-left"></i> Previous
                            </button>
                            <span class="badge bg-primary" id="pageInfo">Page 1 of 1</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="changePage(1)" id="nextBtn">
                                Next <i class="bi bi-chevron-right"></i>
                            </button>
                            <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelect" onchange="changePageSize()">
                                <option value="10">10 per page</option>
                                <option value="20" selected>20 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>
                    <div id="deleteTransactionInfo"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Confirm Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="messageToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2"></i>
                <strong class="me-auto" id="toastTitle">Message</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 1;
        let pageSize = 20;
        let totalPages = 1;
        let deleteTransactionId = null;
        let isEditing = false;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            setupFormValidation();
        });

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('transactionForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const transactionData = Object.fromEntries(formData.entries());
            
            // Validate required fields
            if (!transactionData.accountNumber || !transactionData.transactionType || !transactionData.amount) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            try {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

                if (isEditing) {
                    await updateTransaction(transactionData);
                } else {
                    await createTransaction(transactionData);
                }
            } catch (error) {
                showMessage('Operation failed: ' + error.message, 'error');
            } finally {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit';
            }
        }

        // Create transaction
        async function createTransaction(data) {
            const response = await fetch('/api/v1/mybank/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create transaction');
            }

            const result = await response.json();
            showMessage('Transaction created successfully', 'success');
            resetForm();
            loadTransactions();
        }

        // Update transaction
        async function updateTransaction(data) {
            const id = document.getElementById('transactionId').value;
            const response = await fetch(`/api/v1/mybank/transactions/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update transaction');
            }

            const result = await response.json();
            showMessage('Transaction updated successfully', 'success');
            cancelEdit();
            loadTransactions();
        }

        // Delete transaction
        async function deleteTransaction(id) {
            const response = await fetch(`/api/v1/mybank/transactions/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete transaction');
            }

            showMessage('Transaction deleted successfully', 'success');
            loadTransactions();
        }

        // Load transaction list
        async function loadTransactions() {
            try {
                const tableBody = document.getElementById('transactionTableBody');
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>';

                const response = await fetch(`/api/v1/mybank/transactions?page=${currentPage}&size=${pageSize}`);
                
                if (!response.ok) {
                    throw new Error('Failed to get transaction list');
                }

                const result = await response.json();
                const transactions = result.data.content;
                totalPages = result.data.totalPages;

                if (transactions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No transaction records found</td></tr>';
                } else {
                    renderTransactionTable(transactions);
                }

                updatePagination();
            } catch (error) {
                document.getElementById('transactionTableBody').innerHTML = 
                    '<tr><td colspan="10" class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i> Load failed: ' + error.message + '</td></tr>';
            }
        }

        // Render transaction table
        function renderTransactionTable(transactions) {
            const tableBody = document.getElementById('transactionTableBody');
            tableBody.innerHTML = '';

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'transaction-card';
                
                const amountClass = getAmountClass(transaction.transactionType);
                const typeText = getTransactionTypeText(transaction.transactionType);
                const statusBadge = getStatusBadge(transaction.status);
                
                row.innerHTML = `
                    <td><strong>${transaction.tid}</strong></td>
                    <td><code>${transaction.accountNumber}</code></td>
                    <td><span class="badge bg-info">${typeText}</span></td>
                    <td class="${amountClass}"><strong>${transaction.amount} ${transaction.currency}</strong></td>
                    <td>${transaction.currency}</td>
                    <td>${transaction.category || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${transaction.description || '-'}</td>
                    <td><small>${formatDateTime(transaction.createdAt)}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editTransaction(${JSON.stringify(transaction).replace(/"/g, '&quot;')})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="showDeleteConfirm('${transaction.tid}', '${transaction.accountNumber}', ${transaction.amount}, '${transaction.currency}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Get amount style class
        function getAmountClass(transactionType) {
            switch (transactionType) {
                case 'DEPOSIT':
                case 'REFUND':
                case 'INTEREST':
                    return 'amount-positive';
                case 'WITHDRAWAL':
                case 'PAYMENT':
                case 'FEE':
                    return 'amount-negative';
                default:
                    return '';
            }
        }

        // Get transaction type text
        function getTransactionTypeText(type) {
            const typeMap = {
                'DEPOSIT': 'Deposit',
                'WITHDRAWAL': 'Withdrawal',
                'TRANSFER': 'Transfer',
                'PAYMENT': 'Payment',
                'REFUND': 'Refund',
                'FEE': 'Fee',
                'INTEREST': 'Interest'
            };
            return typeMap[type] || type;
        }

        // Get status badge
        function getStatusBadge(status) {
            if (!status) return '<span class="badge bg-secondary">Unknown</span>';
            
            const statusMap = {
                'PENDING': 'bg-warning',
                'COMPLETED': 'bg-success',
                'FAILED': 'bg-danger',
                'CANCELLED': 'bg-secondary'
            };
            
            const statusTextMap = {
                'PENDING': 'Pending',
                'COMPLETED': 'Completed',
                'FAILED': 'Failed',
                'CANCELLED': 'Cancelled'
            };
            
            return `<span class="badge ${statusMap[status] || 'bg-secondary'} status-badge">${statusTextMap[status] || status}</span>`;
        }

        // Format date time
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('en-US');
        }

        // Edit transaction
        function editTransaction(transaction) {
            isEditing = true;
            
            document.getElementById('formTitle').innerHTML = '<i class="bi bi-pencil-square"></i> Edit Transaction';
            document.getElementById('transactionId').value = transaction.tid;
            document.getElementById('accountNumber').value = transaction.accountNumber;
            document.getElementById('transactionType').value = transaction.transactionType;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('currency').value = transaction.currency;
            document.getElementById('category').value = transaction.category || '';
            document.getElementById('description').value = transaction.description || '';
            document.getElementById('status').value = transaction.status || '';
            
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle"></i> Update';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            // Scroll to form
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel edit
        function cancelEdit() {
            isEditing = false;
            resetForm();
        }

        // Reset form
        function resetForm() {
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionId').value = '';
            document.getElementById('formTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Create New Transaction';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle"></i> Submit';
            document.getElementById('cancelBtn').style.display = 'none';
        }

        // Show delete confirmation
        function showDeleteConfirm(tid, accountNumber, amount, currency) {
            deleteTransactionId = tid;
            document.getElementById('deleteTransactionInfo').innerHTML = `
                <div class="alert alert-warning">
                    <strong>Transaction ID:</strong> ${tid}<br>
                    <strong>Account Number:</strong> ${accountNumber}<br>
                    <strong>Amount:</strong> ${amount} ${currency}
                </div>
            `;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Confirm delete
        async function confirmDelete() {
            if (deleteTransactionId) {
                try {
                    await deleteTransaction(deleteTransactionId);
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    deleteTransactionId = null;
                } catch (error) {
                    showMessage('Delete failed: ' + error.message, 'error');
                }
            }
        }

        // Refresh transaction list
        function refreshTransactions() {
            loadTransactions();
        }

        // Change page
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadTransactions();
            }
        }

        // Change page size
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            loadTransactions();
        }

        // Update pagination controls
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        // Show message
        function showMessage(message, type = 'info') {
            const toast = document.getElementById('messageToast');
            const title = document.getElementById('toastTitle');
            const messageEl = document.getElementById('toastMessage');
            
            title.textContent = type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Info';
            messageEl.textContent = message;
            
            toast.className = `toast ${type === 'error' ? 'bg-danger text-white' : type === 'success' ? 'bg-success text-white' : ''}`;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html>
