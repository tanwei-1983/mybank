<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>银行交易管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .amount-positive { color: #28a745; }
        .amount-negative { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>银行交易管理系统</h1>
        
        <!-- 操作按钮 -->
        <div class="mb-3">
            <button class="btn btn-primary" onclick="showCreateModal()">新建交易</button>
            <button class="btn btn-secondary" onclick="loadTransactions()">刷新</button>
        </div>

        <!-- 交易列表 -->
        <div id="transactionsList"></div>
        
        <!-- 分页 -->
        <div id="pagination" class="mt-3"></div>
    </div>

    <!-- 模态框 -->
    <div class="modal fade" id="transactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">新建交易</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <input type="hidden" id="transactionId">
                        <div class="mb-3">
                            <label for="accountNumber" class="form-label">账户号码</label>
                            <input type="text" class="form-control" id="accountNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="transactionType" class="form-label">交易类型</label>
                            <select class="form-select" id="transactionType" required>
                                <option value="">请选择</option>
                                <option value="DEPOSIT">存款</option>
                                <option value="WITHDRAWAL">取款</option>
                                <option value="TRANSFER">转账</option>
                                <option value="PAYMENT">支付</option>
                                <option value="REFUND">退款</option>
                                <option value="FEE">手续费</option>
                                <option value="INTEREST">利息</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">金额</label>
                            <input type="number" class="form-control" id="amount" required min="0.01" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">描述</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 10;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
        });

        // 加载交易列表
        async function loadTransactions() {
            try {
                const response = await fetch(`/api/transactions?page=${currentPage}&size=${pageSize}`);
                const data = await response.json();
                
                if (data.success) {
                    displayTransactions(data.data);
                } else {
                    alert('加载失败: ' + data.message);
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }

        // 显示交易列表
        function displayTransactions(pageData) {
            const container = document.getElementById('transactionsList');
            const transactions = pageData.content;
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="alert alert-info">暂无交易记录</div>';
                return;
            }

            const html = transactions.map(transaction => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>${transaction.transactionId}</strong><br>
                                <small class="text-muted">${new Date(transaction.createdAt).toLocaleString()}</small>
                            </div>
                            <div class="col-md-2">${transaction.accountNumber}</div>
                            <div class="col-md-2">${transaction.transactionType}</div>
                            <div class="col-md-2">
                                <span class="amount-${transaction.amount >= 0 ? 'positive' : 'negative'}">
                                    ${transaction.amount} ${transaction.currency}
                                </span>
                            </div>
                            <div class="col-md-2">${transaction.category || '-'}</div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${transaction.id})">编辑</button>
                            </div>
                        </div>
                        ${transaction.description ? `<div class="mt-2"><small>${transaction.description}</small></div>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            // 更新分页
            updatePagination(pageData);
        }

        // 更新分页
        function updatePagination(pageData) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>第 ${pageData.page} 页，共 ${pageData.totalPages} 页，总计 ${pageData.totalElements} 条</div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(${pageData.page - 1})" ${pageData.page <= 1 ? 'disabled' : ''}>上一页</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="changePage(${pageData.page + 1})" ${pageData.page >= pageData.totalPages ? 'disabled' : ''}>下一页</button>
                    </div>
                </div>
            `;
        }

        // 显示创建模态框
        function showCreateModal() {
            document.getElementById('modalTitle').textContent = '新建交易';
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionId').value = '';
            new bootstrap.Modal(document.getElementById('transactionModal')).show();
        }

        // 编辑交易
        async function editTransaction(id) {
            try {
                const response = await fetch(`/api/transactions/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const transaction = data.data;
                    document.getElementById('modalTitle').textContent = '编辑交易';
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('accountNumber').value = transaction.accountNumber;
                    document.getElementById('transactionType').value = transaction.transactionType;
                    document.getElementById('amount').value = transaction.amount;
                    document.getElementById('description').value = transaction.description || '';
                    
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                } else {
                    alert('获取交易信息失败');
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }

        // 保存交易
        async function saveTransaction() {
            const form = document.getElementById('transactionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const transactionId = document.getElementById('transactionId').value;
            const transactionData = {
                accountNumber: document.getElementById('accountNumber').value,
                transactionType: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('amount').value),
                currency: 'CNY',
                description: document.getElementById('description').value,
                category: 'OTHER'
            };

            try {
                const url = transactionId ? `/api/transactions/${transactionId}` : '/api/transactions';
                const method = transactionId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });

                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
                    alert(transactionId ? '更新成功' : '创建成功');
                    loadTransactions();
                } else {
                    alert('操作失败: ' + data.message);
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }

        // 切换页面
        function changePage(page) {
            if (page >= 1) {
                currentPage = page;
                loadTransactions();
            }
        }
    </script>
</body>
</html>
